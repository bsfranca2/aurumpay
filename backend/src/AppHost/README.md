# Local HTTPS Setup for Development (`mkcert`)

This project uses .NET Aspire and includes a Caddy container configured as a reverse proxy. This setup handles local development requests, including routing to different services (API, Frontend) and supporting wildcard subdomains (e.g., `store1.pay.checkout.local`, `store2.pay.checkout.local`) over HTTPS.

To enable trusted local HTTPS connections, avoid browser security warnings, and allow server-side processes (like Nuxt SSR) to trust the local HTTPS endpoint, we use `mkcert`. `mkcert` is a simple tool for making locally-trusted development certificates.

## Prerequisites

*   **`mkcert`**: You need to have `mkcert` installed on your development machine.
    *   Installation Instructions: [https://github.com/FiloSottile/mkcert#installation](https://github.com/FiloSottile/mkcert#installation)
    *   Ensure `mkcert` is available in your system's PATH after installation.

## Setup Steps

Follow these steps to generate the necessary certificates.

### Step 1: Install the Local Certificate Authority (CA)

This step creates a local Certificate Authority (CA) and registers it in your system and browser trust stores. This allows your machine and browsers to trust the certificates generated by `mkcert`.

**You only need to perform this step once per machine.**

1.  Open your terminal or command prompt.
2.  Run the following command:
    ```bash
    mkcert -install
    ```
3.  You might be prompted for your administrator/system password to modify the trust stores.

### Step 2: Generate the Wildcard Certificate for `*.pay.checkout.local`

Now, generate the specific certificate files needed by the Caddy configuration in this project.

1.  **Navigate to the Certificate Directory:**
    The Aspire application expects the certificate files to be located in the `certs` directory within this AppHost project (e.g., `src/AppHost/certs`).

    ```bash
    # Navigate to your AppHost project directory (adjust path if necessary)
    # Example:
    # cd /path/to/your/solution/backend/src/AppHost
    cd path/to/your/AspireSolution/src/AppHost

    # Create the 'certs' directory if it doesn't exist (-p prevents errors if it exists)
    mkdir -p certs

    # Enter the 'certs' directory
    cd certs
    ```

2.  **Generate Certificate Files:**
    Run the `mkcert` command to generate the certificate (`.pem`) and private key (`-key.pem`) files. We generate for the wildcard domain `*.pay.checkout.local` used by the checkout application and also include `localhost` (useful for general local testing or accessing Caddy directly if needed).

    ```bash
    # Generate certificate and key for *.pay.checkout.local and localhost variants
    mkcert "*.pay.checkout.local" localhost 127.0.0.1 ::1
    ```

    This command will create two files in the `certs` directory, with names similar to:
    *   `_wildcard.pay.checkout.local+3.pem` (Public Certificate file)
    *   `_wildcard.pay.checkout.local+3-key.pem` (Private Key file)

    *(Note: The `+3` or similar suffix might vary depending on existing files or mkcert version).*

3.  **(Recommended) Rename Files for Consistency:**
    The Aspire `Program.cs` configuration for Caddy is likely configured to look for specific filenames (`local-dev-cert.pem` and `local-dev-key.pem`) for simplicity and consistency. Rename the files generated in the previous step:

    ```bash
    # Adjust the source filenames if mkcert generated slightly different names
    mv "_wildcard.pay.checkout.local+3.pem" local-dev-cert.pem
    mv "_wildcard.pay.checkout.local+3-key.pem" local-dev-key.pem
    ```

## Result

Once these steps are completed:

*   You should have `local-dev-cert.pem` and `local-dev-key.pem` inside the `src/AppHost/certs` directory.
*   When you run the Aspire AppHost project:
    *   The Caddy container will mount and use these certificates.
    *   Your browser should show a valid HTTPS connection (e.g., a padlock icon) when accessing `https://<subdomain>.pay.checkout.local:8443` (or the configured host port).
    *   Server-side requests originating from the Nuxt application (during SSR) to the HTTPS endpoint should also succeed without TLS errors, assuming the Node.js process is correctly configured (e.g., via the `NODE_EXTRA_CA_CERTS` environment variable pointing to the `mkcert` root CA).

If you encounter issues, double-check that the files exist in the correct `certs` directory and that the filenames match what's expected in the Caddy configuration within `Program.cs`.